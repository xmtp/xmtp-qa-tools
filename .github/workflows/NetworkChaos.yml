name: Network Chaos Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  chaos-test:
    name: Local Network Chaos Tests Against 4-node XMTP-go cluster
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        test_file:
          - smoketests.test.ts
          - dm-duplicate-prevention.test.ts
          - group-partition-delayedreceive.test.ts
          - node-blackhole.test.ts
          - networkchaos.test.ts
          - group-reconciliation.test.ts
          - group-client-partition.test.ts
          - keyrotation.test.ts

    env:
      XMTP_ENV: local
      REGION: ${{ vars.REGION }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    steps:
      - name: Setup test env
        uses: ./.github/actions/xmtp-test-setup
        with:
          cache-data: false
          test-name: ${{ matrix.test_file }}
          env: local

      - name: Install Linux Networking Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y iproute2

      - name: Initial Docker Setup
        run: ./multinode/ci.sh

      - name: Run ${{ matrix.test_file }}
        run: |
          FILE=monitoring/networkchaos/${{ matrix.test_file }}
          echo "Running $FILE"
          if ! npx vitest run $FILE; then
            echo "Initial run failed for $FILE. Retrying after env reset..."
            ./multinode/ci.sh
            npx vitest run $FILE
          fi

      - name: Cleanup and upload artifacts
        if: always()
        uses: ./.github/actions/xmtp-test-cleanup
        with:
          test-name: ${{ matrix.test_file }}
          env: local

      - name: Tear Down Docker
        if: always()
        run: cd multinode && docker compose down

      - name: Send Slack notification on failure
        if: failure() || cancelled()
        uses: ./.github/actions/slack-notification
        with:
          workflow-name: "Network Chaos (${{ matrix.test_file }})"
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
