# PM2 Implementation for Agent SDK Bots

## Overview

When implementing PM2 process management for XMTP Agent SDK bots, follow these patterns to ensure proper restart behavior, logging, and error handling.

## Ecosystem Config File

Create `agents/bots/<bot-name>/ecosystem.config.cjs` with the following structure:

```javascript
const path = require("path");

// Config file is at agents/bots/<bot-name>/ecosystem.config.cjs
// Go up 3 levels to get to project root
const projectRoot = path.resolve(__dirname, "../../..");

module.exports = {
  apps: [
    {
      name: "<bot-name>-bot",
      script: "node_modules/.bin/tsx",
      args: path.join(projectRoot, "agents/bots/<bot-name>/index.ts"),
      cwd: projectRoot,
      interpreter: "node",
      instances: 1,
      exec_mode: "fork",
      autorestart: true,
      max_memory_restart: "1G",
      error_file: "./logs/pm2-<bot-name>-error.log",
      out_file: "./logs/pm2-<bot-name>-out.log",
      log_date_format: "",
      merge_logs: true,
      restart_delay: 1000,
      exp_backoff_restart_delay: 0,
      max_restarts: 10000,
      min_uptime: 1000,
      stop_exit_codes: [],
      unstable_restarts: 10000, // CRITICAL: Prevents PM2 from stopping restarts
      kill_timeout: 10000,
      listen_timeout: 30000,
      env: {
        NODE_ENV: "production",
      },
    },
  ],
};
```

### Critical Config Settings

- **`unstable_restarts: 10000`** - REQUIRED. Without this, PM2 will stop restarting if it detects the process as "unstable" (crashing too quickly). This allows PM2 to keep restarting even during rapid crash cycles.

- **`max_restarts: 10000`** - Allows many restarts before PM2 gives up

- **`min_uptime: 1000`** - Process must run at least 1 second to be considered stable

- **`restart_delay: 1000`** - Wait 1 second before restarting (prevents rapid restart loops)

- **`stop_exit_codes: []`** - Empty array means PM2 will restart on any exit code

## Agent Code Pattern

### 1. Restart Logging (FIRST THING)

Add restart logging as the very first line of code, before any async operations:

```typescript
// Immediate synchronous log - FIRST THING that runs
console.log(
  `[RESTART] <Bot Name> bot starting - PID: ${process.pid} at ${new Date().toISOString()}`,
);
```

This log appears immediately when PM2 restarts the process, making it easy to track restarts in logs.

### 2. Error Handlers

Add these error handlers after agent creation but before `agent.start()`:

```typescript
// Handle agent-level unhandled errors
agent.on("unhandledError", (error) => {
  console.error("<Bot Name> bot fatal error:", error);
  if (error instanceof Error) {
    console.error("Error stack:", error.stack);
  }
  console.error("Exiting process - PM2 will restart");
  process.exit(1);
});

// Handle process-level uncaught exceptions
process.on("uncaughtException", (error) => {
  console.error(`[UNCAUGHT_EXCEPTION] PID: ${process.pid}`, error);
  process.exit(1);
});

// Handle unhandled promise rejections
process.on("unhandledRejection", (reason) => {
  console.error(`[UNHANDLED_REJECTION] PID: ${process.pid}`, reason);
  process.exit(1);
});
```

### 3. Agent Start Pattern

```typescript
agent.on("start", async () => {
  console.log(`Waiting for messages...`);
  console.log(`Address: ${agent.address}`);
  console.log(`ðŸ”—${getTestUrl(agent.client)}`);
  logDetails(agent).catch(console.error);
  await getSDKVersionInfo(agent, agent.client);
});

await agent.start({});
```

## Log File Naming

Use consistent naming for log files:

- `./logs/pm2-<bot-name>-error.log` - stderr output
- `./logs/pm2-<bot-name>-out.log` - stdout output

Replace `<bot-name>` with the actual bot name (e.g., `gm`, `keycheck`).

## Best Practices

1. **Always include `unstable_restarts`** - This is the most critical setting. Without it, PM2 will stop restarting after detecting "unstable" behavior.

2. **Log restart immediately** - The `[RESTART]` log should be the first thing that runs, before any async operations or .env loading.

3. **Use exit code 1** - Always exit with code 1 on errors so PM2 knows to restart.

4. **Keep error handlers simple** - Log the error with PID for correlation, then exit. Don't add complex logic in error handlers.

5. **Test restart behavior** - After implementing, test that PM2 actually restarts by temporarily adding a test crash:

```typescript
// TEST: Crash after X seconds to test PM2 restart
setTimeout(() => {
  console.error(
    `ðŸ’¥ TEST CRASH - Exiting at ${new Date().toISOString()} - PID: ${process.pid}`,
  );
  process.exit(1);
}, 60000); // 1 minute
```

Then verify you see `[RESTART]` logs appearing after the crash.

## Common Issues

### PM2 Shows "waiting restart" but Never Restarts

**Symptom**: PM2 status shows "waiting restart" but no new process spawns.

**Solution**: Add `unstable_restarts: 10000` to ecosystem config. PM2 is blocking restarts because it thinks the process is unstable.

### No Restart Logs Appearing

**Symptom**: Process crashes but `[RESTART]` logs never appear.

**Solution**:

1. Verify `[RESTART]` log is the very first line of code
2. Check PM2 config has `unstable_restarts: 10000`
3. Check PM2 logs: `pm2 logs <bot-name> --raw`

### Process Restarts Too Quickly

**Symptom**: Process restarts in a tight loop.

**Solution**: Increase `restart_delay` to give the process time to initialize before allowing another restart.

## Example: Complete Bot Structure

```typescript
import { Agent, getTestUrl, logDetails } from "@agents/versions";
import { APP_VERSION } from "@helpers/client";
import { getSDKVersionInfo } from "@helpers/versions";
import { loadEnvFile } from "../../utils/general";

// Immediate synchronous log - FIRST THING that runs
console.log(
  `[RESTART] MyBot bot starting - PID: ${process.pid} at ${new Date().toISOString()}`,
);

// Load .env file only in local development
if (process.env.NODE_ENV !== "production") loadEnvFile(import.meta.url);

const agent = await Agent.createFromEnv({
  dbPath: (inboxId) =>
    (process.env.RAILWAY_VOLUME_MOUNT_PATH ?? ".") +
    `/${process.env.XMTP_ENV}-${inboxId.slice(0, 8)}.db3`,
  appVersion: APP_VERSION,
});

// Handle agent-level unhandled errors
agent.on("unhandledError", (error) => {
  console.error("MyBot bot fatal error:", error);
  if (error instanceof Error) {
    console.error("Error stack:", error.stack);
  }
  console.error("Exiting process - PM2 will restart");
  process.exit(1);
});

// Handle process-level uncaught exceptions
process.on("uncaughtException", (error) => {
  console.error(`[UNCAUGHT_EXCEPTION] PID: ${process.pid}`, error);
  process.exit(1);
});

// Handle unhandled promise rejections
process.on("unhandledRejection", (reason) => {
  console.error(`[UNHANDLED_REJECTION] PID: ${process.pid}`, reason);
  process.exit(1);
});

// Your bot logic here
agent.on("text", async (ctx) => {
  // Handle messages
});

agent.on("start", async () => {
  console.log(`Waiting for messages...`);
  console.log(`Address: ${agent.address}`);
  console.log(`ðŸ”—${getTestUrl(agent.client)}`);
  logDetails(agent).catch(console.error);
  await getSDKVersionInfo(agent, agent.client);
});

await agent.start({});
```

## Reference

See `agents/bots/gm/` and `agents/bots/key-check/` for working examples.
